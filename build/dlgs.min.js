/*! dialogues-client - v0.0.1 - 2013-12-26 */!function(){!function(){var a,b,c;!function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(a,b){return function(){return n.apply(d,v.call(arguments,0).concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){return"string"==typeof a?p[a]?p[a](b):j(o(a,b).f):(a.splice||(s=a,b.splice?(a=b,b=c,c=null):a=d),b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},a._defined=q,c=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("../bower_components/almond/almond",[],function(){}),c("jQuery",[],function(){if(!$)throw new Error("jQuery is required");return $}),c("utils",[],function(){var a=function(b,c){for(var d in c)if(c.hasOwnProperty(d)){var e=typeof b[d];"undefined"===e?b[d]=c[d]:"object"===e&&(b[d]=a(b[d],c[d]))}return b};return{deepExtend:a,getDocumentUrl:function(){var a=document.location;return a.href.substr(0,a.href.length-a.hash.length)}}}),c("cookies",[],function(){return{get:function(a){var b=encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&");return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+b+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},set:function(a,b,c,d){return!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a)?!1:(document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+"; expires=Fri, 31 Dec 9999 23:59:59 GMT"+(c?"; domain="+c:"")+(d?"; path="+d:""),!0)}}}),c("storage",[],function(){return{exists:function(){var a="modernizr";try{return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(b){return!1}},set:function(a,b){localStorage.setItem(a,b)},get:function(a){return localStorage.getItem(a)},remove:function(a){localStorage.removeItem(a)}}}),c("view/comment",["./../jQuery","./../utils"],function(a,b){var c=function(c,d,e){var f=this,g=c.options.render,h=g.selectors,i=c.options.dateFormatter,j=c.options.bodyFormatter;f.$el=null,f.comment=e,f.render=function(){f.$el=a(g.template).data("dlgs-comment",f);var k=e.name||c.options.resources.anonymous;if(e.icon&&h.icon&&a(h.icon,f.$el).attr({alt:k,src:e.icon}),e.website?a(h.website,f.$el).attr({href:e.website}):a(h.website,f.$el).attr({disabled:!0}),a(h.name,f.$el).text(k),h.date&&e.date&&a(h.date,f.$el).text(i(new Date(e.date))),h.commentLink&&e.id){var l="dlgs_"+e.id;a(h.commentLink,f.$el).attr({href:b.getDocumentUrl()+"#"+l}),f.$el.attr({id:l})}a(h.body,f.$el).html(j(e.body)),d.append(f.$el)},f.render()};return c}),c("view/commentsList",["./../jQuery","./comment"],function(a,b){var c=function(c,d){var e=this;e.$container=d;var f=[],g=null;e.contains=function(a){for(var b=0;b<e.commentViews.length;b++)if(f[b].comment.id===a.id)return!0;return!1},e.add=function(d){if(f.length>0)for(var g=d.length-1;g>=0;g--)e.contains(d[g])&&d.splice(g,1);a.each(d,function(a,d){f.push(new b(c,e.$container,d))})},e.scrollToLatest=function(){var a=e.$container.get(0);a.scrollHeight>e.$container.height()&&e.$container.animate({scrollTop:a.scrollHeight},"slow")},c.eventAggregator.on("add-comments",function(a){if(g)for(var b=0;a>b;b++)g.push(a[b]);else _add(a)}),c.eventAggregator.on("form-opened",function(){g=[]}),c.eventAggregator.on("form-submitted",function(a){e.add(g),g=null,e.add([a]),e.scrollToLatest()})};return c}),c("connect/rest",["./../jQuery"],function(a){var b=function(b){this.getAll=function(c){a.getJSON(b.options.server,b.dialoguesId,function(a){c(null,a)}).fail(function(a,b,d){c({message:b,error:d},null)})},this.post=function(c,d){var e=JSON.stringify({dialogues:lgsHost.dialoguesId,comment:c});a.post(b.options.server,e,function(a){d(null,a)},"json").fail(function(a,b,c){d({message:b,error:c},null)})}};return b}),c("view/form",["./../jQuery","./../connect/rest","./../storage","./../cookies"],function(a,b,c,d){var e=function(b){var e=this,f=b.options.host,g=b.options.id,h=b.options.formRender,i=b.options.bodyFormatter,j=h.selectors,k=h.placeholderSelectors,l=f+"_"+g,m="dlgs_backup_"+l,n=b.connect.rest,o=b.eventAggregator;e.$placeholder=a(h.templatePlaceholder).appendTo($parent),e.$form=a(h.template.replace(/{id}/g,l)).appendTo($parent).hide(),e.isOpened=!1;var p=a(j.body,e.$form),q=a(j.username,e.$form),r=a(j.email,e.$form),s=a(j.website,e.$form),t=a(j.subscription,e.$form),u=a(j.preview,e.$form),v=function(){u.html(i(p.val())),c.exists&&(p.val()?c.set(m,p.val()):c.remove(m))},w=function(){d.set("dlgs-participant",JSON.stringify({username:q.val(),email:r.val(),website:s.val()}),document.location.hostname)},x=function(){var a=d.get("dlgs-participant");a&&(a=JSON.parse(a),q.val(a.username),r.val(a.email),s.val(a.website))},y=function(){if(e.$placeholder.hide(),x(),c.exists){var b=c.get(m);b&&p.val(b).trigger("input")}e.$form.fadeIn();var d=e.$form.get(0),f=d.getBoundingClientRect().bottom,g=a(window).height();f>g&&a("body").animate({scrollTop:a("body").scrollTop()+(f-g)},"slow"),p.focus(),e.isOpened=!0},z=function(){e.$form.hide(),e.$placeholder.fadeIn(),p.val("").trigger("input"),e.isOpened=!1},A=function(){var a={username:q.val(),website:s.val(),email:r.val(),subscription:t.prop("checked")||!1,body:p.val()};n.post(a,function(a,b){a||(z(),o.trigger("submitted",b))})};p.on("input",v),a.each([q,r,s],function(a,b){b.on("input",w)}),a(k.button,e.$placeholder).click(function(){return y(),!1}),a(j.cancel,e.$form).click(function(){return z(),!1}),a(j.submit,e.$form).click(function(){return A(),!1})};return e}),c("connect/sockets",[],function(){var a=function(){var a={},b=function(b){return a[b]||(a[b]={socket:null,subscriptions:[]}),a[b]},c=function(b){a[b].socket&&a[b].socket.disconnect(),delete a[b]},d=function(c){var d=b(c);return d.socket?(d=a[c]={socket:io.connect(c),subscriptions:[]},d.socket.on("connect",function(){e(socket,!0,d.subscriptions)}),d.socket.on("reconnect",function(){e(socket,!1,d.subscriptions)}),!1):!0},e=function(a,b,c){$.each(c,function(c){c(a,b)})};this.connect=function(a,c){var f=b(a);f.subscriptions.push(c),d(a)&&e(f.socket,!0)},this.disconnect=function(a,d){for(var e=b(a),f=0;f<e.subscriptions.length;f++)if(e.subscriptions[f]===d){e.subscriptions.splice(f,1);break}0===e.subscriptions.length&&c(a)}},b=null,c=function(){return b||(b=new a)},d=function(a){var b=function(b){b.dialoguesId===a.dialoguesId&&a.eventAggregator.trigger("add-comments",b.comments)},d=function(c,d){d||c.off("update",b),c.on("update",b),c.emit("subscribe",a.dialoguesId)};this.connect=function(){var b=c();b.connect(a.options.server,d),_connect(a.options.server,d)},this.disconnect=function(){socket.off("update",b);var e=c();e.disconnect(a.options.server,d)}};return d}),c("eventAggregator",["./jQuery"],function(a){var b=function(){var b=this,c={};b.on=function(a,b){"undefined"==typeof c[a]&&(c[a]=[]),c[a].push(b)},b.off=function(a,b){if("undefined"!=typeof c[a]){for(var d=0;d<c[a].length;d++)if(c[a][d]===b){c[a].splice(d,1);break}0===c[a].length&&delete c[a]}},b.trigger=function(b,d){"undefined"!=typeof c[b]&&a.each(c[b],function(a,b){b(d)})}};return b}),c("host",["./jQuery","./connect/sockets","./connect/rest","./eventAggregator"],function(a,b,c,d){var e=function(e){this.$el=e.$el?a(e.$el):a("<div />").insertAfter(document.currentScript),this.dialoguesId="string"==typeof e.dialoguesId?e.dialoguesId:JSON.stringify(e.dialoguesId),this.options=e,this.eventAggregator=new d(e),this.connect={},this.connect.rest=new c(this),this.options.load.sockets&&"object"==typeof window.io&&(this.connect.socket=new b(this))};return e}),c("core.js",["./jQuery","./utils","./cookies","./storage","./view/commentsList","./view/form","./host"],function(a,b,c,d,e,f,g){var h={$el:null,host:document.location.hostname,id:document.location.pathname,server:"/api/dialogues/",debug:!1,load:{manual:!1,delay:!0,sockets:!0},render:{templateContainer:'<ul class="dlgs-list" />',template:'<li><section class="dlgs-comment">  <a class="dlgs-participant-website" >    <img class="dlgs-participant-avatar" height=80 width=80 />  </a>  <div class="dlgs-comment-header">    <div>      <a class="dlgs-participant-name dlgs-participant-website" />      <a class="dlgs-comment-link">        <span class="dlgs-comment-date" />      </a>    </div>  </div>  <div class="dlgs-comment-body" /></section></li>',selectors:{name:"a.dlgs-participant-name",website:"a.dlgs-participant-website",icon:"img.dlgs-participant-avatar",date:"span.dlgs-comment-date",body:"div.dlgs-comment-body",commentLink:"a.dlgs-comment-link"}},preloadRender:{template:'<div style="text-align: center;"><a href class="btn btn-primary btn-lg" style="width:80%;">New comments loaded...</button></div>',selectors:{button:"a"}},formRender:{templatePlaceholder:'<div style="text-align: center;"><a href class="btn btn-primary btn-lg" style="width:80%;">Reply</button></div>',placeholderSelectors:{button:"a"},template:'<form role="form" class="dlgs-form"><div class="row">  <div class="col-md-4">    <div class="form-group">      <label for="dlgs-participant-name-{id}">Display name:</label>      <input type="text" class="form-control" name="dlgs-participant-name" id="dlgs-participant-name{-id}" placeholder="Enter display name">    </div>    <div class="form-group">      <label for="dlgs-participant-email-{id}">Email:</label>      <input type="email" class="form-control" name="dlgs-participant-email" id="dlgs-participant-email-{id}" placeholder="Enter email">    </div>    <div class="form-group">      <label for="dlgs-participant-website-{id}">Website:</label>      <input type="url" class="form-control" name="dlgs-participant-website" id="dlgs-participant-website-{id}" placeholder="Enter website">    </div>    <!--<div class="checkbox">      <label>        <input type="checkbox" name="dlgs-participant-subscription" id="dlgs-participant-subscription-{id}"> Notify about new comments      </label>    </div>-->  </div>  <div class="col-md-8">    <div class="form-group">      <label for="dlgs-comment-body-{id}">Body:</label>      <textarea class="form-control" rows="10" name="dlgs-comment-body" id="dlgs-comment-body-{id}" autofocus="true"></textarea>    </div>  </div></div><div class="dlgs-comment-preview" /><div class="form-actions">  <button type="submit" class="btn btn-primary">Submit</button>  <button type="button" class="btn btn-default">Cancel</button></div></form>',selectors:{username:"input[name=dlgs-participant-name]",email:"input[name=dlgs-participant-email]",website:"input[name=dlgs-participant-website]",body:"textarea[name=dlgs-comment-body]",submit:"button[type=submit]",cancel:"button[type=button]",preview:"div.dlgs-comment-preview"}},dateFormatter:function(a){return a.toLocaleString()},bodyFormatter:function(b){return a("<div />").text(b).html().replace(/\n/g,"<br/>")},resources:{anonymous:"Anonymous"}},i=function(c){c=c?b.deepExtend(c,h):h;var d=new g(c);this._options=c,this._load=c.load,this._render=c.render,this._commentsContainer=a(this._render.templateContainer).appendTo(host.$el),this._preloadedCommentsButton=null;var i=[],j=!1,k=new e(d,this._commentsContainer),l=null,m=function(){i.sort(function(a,b){return a.date-b.date}),k.add(i),k.scrollToLatest(),this._preloadedCommentsButton&&(this._preloadedCommentsButton.remove(),i=[],this._preloadedCommentsButton=null)}.bind(this);if(host.eventAggregator.on("submitted",function(a){i.length>0&&m(),k.add(a),k.scrollToLatest()}),this.load=function(){host.connect.rest.getAll(function(b,c){return b?(console.error("Cannot load comments from server, error: "+error+", response: "+status),void 0):(host.$el.hide(),k.add(c),this._options.formRender&&(l=new f(host)),host.$el.fadeIn(),host.connect.socket&&(host.connect.socket.connect(),host.connect.sockets.subscribe({host:this._options.host,id:this._options.id},function(b){var c;for(c=b.comments.length-1;c>=0;c--)k.contains(b.comments[c])&&b.comments.splice(c,1);if(j||i.length>0){for(c=0;c<b.comments.length;c++)i.push(b.comments[c]);if(i.length>0&&!this._preloadedCommentsButton){var d=this._options.preloadRender;this._preloadedCommentsButton=a(d.template).insertAfter(this._commentsContainer),a(d.selectors.button,this._preloadedCommentsButton).click(function(){return m(),!1}.bind(this))}}else k.add(b.comments)}.bind(this))),void 0)})}.bind(this),this._load&&!this._load.manual)if(this._load.delay){var n=!1,o=function(){!n&&host.$el[0].getBoundingClientRect().top<=window.innerHeight&&(this.load(),n=!0)}.bind(this);o(),n||(window.onscroll=o)}else this.load()};return i}),c("dialogues",["./core.js"],function(a){var b=window,c=b.dialogues;return{noConflict:function(){return b.dialogues=c,module},render:function(b){return new a(b)}}})}()}();